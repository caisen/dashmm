\chapter{Advanced Guide to DASHMM}
\label{ch:advanced}

In this chapter, the complete interface to DASHMM will be presented. This will
cover some repeat information as the previous chapter, but will provide more
details that are not relevant for the basic usage of DASHMM. In a few cases,
the coverage of a library construct is complete in the previous chapter, and
so those topics will not be repeated here.

The fundamental difference between the basic and advanced interface to
DASHMM is that the advanced interface is needed when a user is implementing
a new Expansion or Method. This will require a user to be familiar with more
of the details of how the execution is performed, and will thus require some
more details about how HPX-5 provides parallelism to DASHMM. However, the
extent to which a user will have to learn HPX-5 directly is still extremely
limited.

The arrangement of material in this chapter will parallel the arrangement in
the previous.

\section{DASHMM Concepts}

This sections covers the conceptual framwork of both DASHMM's implementation
of general multipole methods and the parallelization of those methods with
HPX-5.

\subsection{Multipole method abstractions}

Both mathematically, and in the code. So the operations and the template
arguments.

\subsection{Parallelization abstractions}

More detail about this that is relevant for advanced use of the library.



\section{Basic types}

The following basic types are needed when implementing user-defined methods and
expansions.

\subsection{\texttt{Operation}}

DASHMM organizes the transformations between various forms of the potential
expansion into a set of operations. The \texttt{Operation} scoped enumeration
identifies the operations that DASHMM recognizes. They are: \texttt{Nop},
\texttt{StoM}, \texttt{StoL}, \texttt{MtoM}, \texttt{MtoL}, \texttt{LtoL},
\texttt{MtoT}, \texttt{LtoT}, \texttt{StoT}, \texttt{MtoI}, \texttt{ItoI}
and \texttt{ItoL}.

\subsection{\texttt{ExpansionRole}}

DASHMM creates Expansion objects in a number of roles. The role is essentially
a description of which tree in the dual tree an expansion is most closely
associated with, and whether the expansion is a primary or intermediate
expansion.  The \texttt{ExpansionRole} is an enumeration with the following
members: \texttt{kSourcePrimary}, \texttt{kSourceIntermediate},
\texttt{kTargetPrimary}, \texttt{kTargetIntermediate} and
\texttt{kNoRoleNeeded}. The latter is for situations that that require an
operation from the Expansion type, but which do not require expansion data.
The prototypical example of this is the \texttt{S->T} operation.

\subsection{\texttt{Index}}

Each node of both the source and target trees can be identified with four
integers: the level of the tree (starting with 0 for the root), and the
position of the low corner of the node in units of the node size at the given
level. The index allows DASHMM to not only perform accurate positional
comparisions, but also to provide an ordering of the nodes of the tree at a
given level.

\subsubsection{\texttt{Index::Index(int ix = 0, int iy = 0, int iz = 0, int lvl = 0)}}

Construct an Index with the given on-level position and level.

\subsubsection{\texttt{int Index::x() const}}

Return the on-level position in the x direction.

\subsubsection{\texttt{int Index::y() const}}

Return the on-level position in the y direction.

\subsubsection{\texttt{int Index::z() const}}

Return the on-level position in the z direction.

\subsubsection{\texttt{int Index::level() const}}

Return the level of the index.

\subsubsection{\texttt{Index Index::parent(int num = 1) const}}

Return the \texttt{num}-th parent of this \texttt{Index}.

\subsubsection{\texttt{Index Index::child(int which) const}}

Return the given child of this Index. \texttt{which} is a composite value
that indicates with each bit if the child is on the left or right in that
direction. For example for \texttt{which == 6}, the child is the left child
in the z-direction, and the right child in both the y and x directions.

\subsubsection{\texttt{int Index::which\_child() const}}

Return which child of its parent, this node is.

\subsubsection{\texttt{bool Index::operator==(const Index \&other) const}}

Equality operator.


\subsection{\texttt{DomainGeometry}}

To represent the computational domain of the sources and targets, DASHMM
uses the \texttt{DomainGeometry} object. This object can be used to convert
an \texttt{Index} into \texttt{Point}s for various locations in the volume
represented by that index. The domains represented by DASHMM are cubical
regions.

\subsubsection{\texttt{DomainGeometry::DomainGeometry()}}

Default construct a domain to begin at the origin, with a zero side length.

\subsubsection{\texttt{DomainGeometry::DomainGeometry(Point low, double size)}}

Construct a domain with the given low corner, and the given side length.

\subsubsection{\texttt{DomainGeometry::DomainGeometry(Point low, Point high, double f = 1.0)}}

Construct a domain from the given low and high corners. The given region need
not be cubical. The resulting object will represent the smallest cube that
contains the specified volume. Additionally, the final parameter can be used
to enlarge the resulting cube by a fixed fraction.

\subsubsection{\texttt{double DomainGeometry::size() const}}

Return the side length of the represented cubical volume.

\subsubsection{\texttt{Point DomainGeometry::low() const}}

Return the low corner of the represented volume.

\subsubsection{\texttt{Point DomainGeometry::high() const}}

Return the high corner of the represented volume.

\subsubsection{\texttt{Point DomainGeometry::center() const}}

Return the center of the represented volume.

\subsubsection{\texttt{Point DomainGeometry::low\_from\_index(Index idx) const}}

Return the low corner of the region represented by the given index.

\subsubsection{\texttt{Point DomainGeometry::high\_from\_index(Index idx) const}}

Return the high corner of the region represented by the given index.

\subsubsection{\texttt{Point DomainGeometry::center\_from\_index(Index idx) const}}

Return the center of the region represented by the given index.

\subsubsection{\texttt{double DomainGeometry::size\_from\_index(Index idx) const}}

Return the size of the region represented by the given index.



\section{Initializing DASHMM}

Initialization of DASHMM via \texttt{init()} requires providing the command
line arguments to the program. This is to provide the opportunity to HPX-5 to
detect any command line arguments that modify its behavior. A full description
of the available options can be found in the HPX-5 documentation. Here, we
shall cover those that are most relevant for programs using DASHMM.

NOTE: The material in this section should not be considered to be part of the
library's interface, and are subject to modification out of the control of
the DASHMM development team.

The following HPX-5 command line arguments are the most relevant to DASHMM:

\subsubsection{\texttt{--hpx-help}}

Display a help message giving a brief description of all available options.

\subsubsection{\texttt{--hpx-threads}}

Specify the number of scheduler threads that HPX-5 will use per rank.
Typically, one thread per core gives best results, but fewer is sometimes
useful in scalability studies.

\subsubsection{\texttt{--hpx-heapsize}}

Specify the size in bytes of the amount of global address space available to
each rank. The default is frequently too low for large problem sizes. This,
however, should not be set to take all of the system memory.



\section{Evaluation}

The \texttt{Evaluator} object has one additional feature that was not
covered in the previous chapter. In addition to the parameters outlined
in Chapter~\ref{ch:basic}, one final optional parameter is available.

Each Method has a distribution policy that specifies how the DAG nodes are
to be distributed around the available resources. To allow for these policies
to have some parameters selectable at runtime, the
\texttt{Evaluator::evaluate} method accepts a distribution policy object.
This allows for users to fine-tune the behavior of the distribution if needed.
When the final argument is not supplied, DASHMM employs a default constructed
object of the type \texttt{Method<Source, Target, Expansion>::distropolicy\_t},
where \texttt{Method, Source, Target} and \texttt{Expansion} are the template
arguments supplied to the particular instance of \texttt{Evaluator}.



\section{Array map actions}

The \texttt{ArrayMapAction} utility class supports a third template parameter
that controls the level of parallelism employed in the mapping of the work
to the records in the array. This parameter is an integer that has the
following meaning: if the argument is zero, the array will be handled in a
single chunk; if the argument is positive, the array will be handled in a number
of chunks equal to the number of HPX-5 scheduler threads times the provided
argument.

The default value of this argument is 1, so the default operation of
the map will be to split each rank's portion of the array into a number of
equally sized pieces equal to the number of scheduler threads. Unless there is
the possibility for variation in the amount of computation that the mapped
action performs per record, it is likely that the default value will be
the sufficient. If, however, the work for each record is variable, better
performance may be achieved with smaller chunks, and thus larger third arguments
to the template.

The full declaration of \texttt{ArrayMapAction} is as follows:

\begin{verbatim}
template <typename T, typename E, int factor = 1>
class ArrayMapAction;
\end{verbatim}



\section{DAG objects}

After the dual tree is constructed, DASHMM creates an explicit representation
of the DAG for the given method applied to the just constructed tree. This DAG
is used to perform a work distribution, and to act as a scaffold from which
the actual expansion data is instantiated. For users wishing to implement
their own methods, the DAG objects are the objects that will be needed. In
DASHMM, the Method builds a DAG from the dual tree. There are 4 classes that
make up the DAG system for DASHMM: \texttt{DAG}, \texttt{DAGInfo},
\texttt{DAGNode} and \texttt{DAGEdge}, which will be covered in turn.

\subsection{\texttt{DAGEdge}}

The edges connecting nodes in the DAG is described with the \texttt{DAGEdge}
type. This simple type holds a pointer to the source and target
\texttt{DAGNode} connected by the edges, the \texttt{Operation} that the edge
represents, and an integer weight that gives an estimate of the communication
cost of the edge. The weight is optionally used by the distribution policy to
aid in the decision about data placement around the system. The full definition
of \texttt{DAGEdge} is as follows:

\subsubsection{\texttt{DAGNode *DAGEdge::source}}

Source node of the edge.

\subsubsection{\texttt{DAGNode *DAGEdge::target}}

Target node of the edge.

\subsubsection{\texttt{Operation DAGEdge::op}}

Operation to perform along edge.

\subsubsection{\texttt{int DAGEdge::weight}}

Estimate of communication cost required if the edge were to span localities.


\subsection{\texttt{DAGNode}}

The nodes of the DAG are represented by the simple type \texttt{DAGNode}. It
contains the following public members:

\subsubsection{\texttt{std::vector<DAGEdge> DAGNode::out\_edges}}

The edges of the DAG that start at this node.

\subsubsection{\texttt{std::vector<DAGEdge> DAGNode::in\_edges}}

The edges of the DAG that end at this node.

\subsubsection{\texttt{Index DAGNode::idx}}

The index of the tree node to which this DAG node is associated.

\subsubsection{\texttt{int DAGNode::locality}}

The locality to which this node will be assigned by the distribution. Note
that this will most often be set by the distribution policy. To indicate that
the locality is not set, a value of \texttt{-1} should be used.

\subsubsection{\texttt{int DAGNode::color}}

A color that might be used by the distribution policy. This has meaning only
in the context of the distribution policy.

\subsubsection{\texttt{DAGNode::DAGNode(Index i)}}

Construct a DAG node. This will set the index to the given value, give the
locality a value of \texttt{-1}, and default construct the remaining members
of the node.


\subsection{\texttt{DAG}}

The \texttt{DAG} object is given to a distribution policy when computing the
localities of the nodes in the DAG. This is another simple object that contains
four containers of the nodes of the DAG. These containers separate the nodes
by their position in the DAG.

The \texttt{DAG} object has the following members:

\subsubsection{\texttt{std::vector<DAGNode *> source\_leaves}}

Nodes of the DAG that are associated with leaves of the source tree. These
nodes will have no incoming edges.

\subsubsection{\texttt{std::vector<DAGNode *> source\_nodes}}

All other DAG nodes that are associated with nodes of the source tree.

\subsubsection{\texttt{std::vector<DAGNode *> target\_leaves}}

Nodes of the DAG that are associated with leaves of the target tree. These
nodes will have no outgoing edges. In some methods, these are not associated
with the leaves of the target tree, but rather those nodes of the target
tree after which more refinement for the method would only induce
unnecessary overhead.

\subsubsection{\texttt{std::vector<DAGNode *> target\_nodes}}

All other DAG nodes that are associated with node of the target tree.



\subsection{\texttt{DAGInfo}}

The \texttt{DAGInfo} object contains all the information related to the DAG
for each node of the source and target trees. These objects will be the
primary means by which a Method interacts with the DAG.

Each \texttt{DAGInfo} object represents up to three DAG nodes: a particles
node, the normal DAG node, and an intemediate DAG node. The particles node
represents the terminal nodes of the DAG: either the information about
the sources, or the information about the targets. These DAG nodes do not
represent expansions. The normal
DAG node represents expansions with a role of \texttt{kSourcePrimary} or
\texttt{KTargetPrimary}. The intermediate node represents expansions with a
role of \texttt{kSouceIntermediate} or \texttt{kTargetIntermediate}. A
particular method might not use certain expansion roles, so a
\texttt{DAGInfo} object might not contain the normal or intermediate DAG node.
Further, not all tree nodes are leaves, and so only some \texttt{DAGInfo}
objects will have a particles node.

This object manages the concurrent modification of the DAG. However, that
management is hidden from users of this object.

The \texttt{DAGInfo} methods that a user might need to use in a Method are
covered below.

\subsubsection{\texttt{Index DAGInfo::index() const}}

Return the index of the volume represented by the DAG nodes owned by this
object.

\subsubsection{\texttt{bool DAGInfo::add\_normal()}}

Add a normal DAG node to this object. This will return \texttt{true} if this
call added the node. Otherwise, if the \texttt{DAGNode} already owns a normal
node, this call will do nothing, and return false.

\subsubsection{\texttt{bool DAGInfo::add\_interm()}}

Add an intermediate DAG node to this object. This will return \texttt{true} if
this call added the node. Otherwise, if the \texttt{DAGNode} already owns an
intermediate node, this call will do nothing, and return \texttt{false}.

\subsubsection{\texttt{bool DAGInfo::add\_parts()}}

Add a particles DAG node to this object. This will return \texttt{true} if this
call added the node. Otherwise, if the \texttt{DAGNode} already owns a particles
node, this call will do nothing, and return false.

\subsubsection{\texttt{bool DAGInfo::has\_normal() const}}

Predicate returning if this object owns a normal DAG node.

\subsubsection{\texttt{bool DAGInfo::has\_interm() const}}

Predicate returning if this object owns an intermediate DAG node.

\subsubsection{\texttt{bool DAGInfo::has\_parts() const}}

Predicate returning of this object owns a particles DAG node.

\subsubsection{\texttt{void DAGInfo::set\_normal\_locality(int loc)}}

Set the locality for the normal DAG node, if it exists, to the given
locality, \texttt{loc}.

\subsubsection{\texttt{void DAGInfo::set\_interm\_locality(int loc)}}

Set the locality for the intermediate DAG node, if it exists, to the given
locality, \texttt{loc}.

\subsubsection{\texttt{void DAGInfo::StoM(DAGInfo *source, int weight)}}

Connect the particles DAG node of \texttt{source} to the normal DAG node of
this object with an \texttt{S->M} operation, and assign the resulting edge the
given \texttt{weight}. It is an error to call this method if this object does
not own a normal DAG node, and if the \texttt{source} does not own a particles
DAG node.

\subsubsection{\texttt{void DAGInfo::StoL(DAGInfo *source, int weight)}}

Connect the particles DAG node of \texttt{source} to the normal DAG node of
this object with an \texttt{S->L} operation, and assign the resulting edge the
given \texttt{weight}. It is an error to call this method if this object does
not own a normal DAG node, and if the \texttt{source} does not own a particles
DAG node.

\subsubsection{\texttt{void DAGInfo::MtoM(DAGInfo *source, int weight)}}

Connect the normal DAG node of \texttt{source} to the normal DAG node of
this object with an \texttt{M->M} operation, and assign the resulting edge the
given \texttt{weight}. It is an error to call this method if this object does
not own a normal DAG node, and if the \texttt{source} does not own a normal
DAG node.

\subsubsection{\texttt{void DAGInfo::MtoL(DAGInfo *source, int weight)}}

Connect the normal DAG node of \texttt{source} to the normal DAG node of
this object with an \texttt{M->L} operation, and assign the resulting edge the
given \texttt{weight}. It is an error to call this method if this object does
not own a normal DAG node, and if the \texttt{source} does not own a normal
DAG node.

\subsubsection{\texttt{void DAGInfo::LtoL(DAGInfo *source, int weight)}}

Connect the normal DAG node of \texttt{source} to the normal DAG node of
this object with an \texttt{L->L} operation, and assign the resulting edge the
given \texttt{weight}. It is an error to call this method if this object does
not own a normal DAG node, and if the \texttt{source} does not own a normal
DAG node.

\subsubsection{\texttt{void DAGInfo::MtoT(DAGInfo *target, int weight)}}

Connect the normal DAG node of this object to the particles DAG node of
\texttt{source} with an \texttt{M->T} operation, and assign the resulting edge
the given \texttt{weight}. It is an error to call this method if this object
does not own a normal DAG node, and if the \texttt{source} does not own a
particles DAG node.

\subsubsection{\texttt{void DAGInfo::LtoT(DAGInfo *target, int weight)}}

Connect the normal DAG node of this object to the particles DAG node of
\texttt{source} with an \texttt{L->T} operation, and assign the resulting edge
the given \texttt{weight}. It is an error to call this method if this object
does not own a normal DAG node, and if the \texttt{source} does not own a
particles DAG node.

\subsubsection{\texttt{void DAGInfo::StoT(DAGInfo *source, int weight)}}

Connect the particles DAG node of \texttt{source} to the particles DAG node of
this object with an \texttt{S->T} operation, and assign the resulting edge the
given \texttt{weight}. It is an error to call this method if this object does
not own a particles DAG node, and if the \texttt{source} does not own a
particles DAG node.

\subsubsection{\texttt{void DAGInfo::MtoI(DAGInfo *source, int weight)}}

Connect the normal DAG node of \texttt{source} to the intermediate DAG node of
this object with an \texttt{M->I} operation, and assign the resulting edge the
given \texttt{weight}. It is an error to call this method if this object does
not own a normal DAG node, and if the \texttt{source} does not own an
intermediate DAG node.

\subsubsection{\texttt{void DAGInfo::ItoI(DAGInfo *source, int weight)}}

Connect the intermediate DAG node of \texttt{source} to the intermediate DAG
node of this object with an \texttt{I->I} operation, and assign the resulting
edge the given \texttt{weight}. It is an error to call this method if this
object does not own an intermediate DAG node, and if the \texttt{source} does
not own an intermediate DAG node.

\subsubsection{\texttt{void DAGInfo::ItoL(DAGInfo *source, int weight)}}

Connect the intermediate DAG node of \texttt{source} to the normal DAG
node of this object with an \texttt{I->L} operation, and assign the resulting
edge the given \texttt{weight}. It is an error to call this method if this
object does not own a normal DAG node, and if the \texttt{source} does
not own an intermediate DAG node.


\section{Built-in distribution policies}

Also go over the default policy



\section{User-defined Expansions}



\section{User-defined Methods}



\section{User-defined distribution policies}
